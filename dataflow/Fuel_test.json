{
	"name": "Fuel_test",
	"properties": {
		"type": "MappingDataFlow",
		"typeProperties": {
			"sources": [
				{
					"dataset": {
						"referenceName": "VolvoCE_Fuel_SQL",
						"type": "DatasetReference"
					},
					"name": "VolvoCE"
				},
				{
					"dataset": {
						"referenceName": "CAT_Snapshot",
						"type": "DatasetReference"
					},
					"name": "CAT"
				},
				{
					"dataset": {
						"referenceName": "SQLMachine",
						"type": "DatasetReference"
					},
					"name": "Machine"
				},
				{
					"dataset": {
						"referenceName": "VolvoTruckStatusNewData",
						"type": "DatasetReference"
					},
					"name": "VolvoTrucks"
				}
			],
			"sinks": [
				{
					"dataset": {
						"referenceName": "SQL_AllFuel",
						"type": "DatasetReference"
					},
					"name": "sink1"
				}
			],
			"transformations": [
				{
					"name": "Fjernlinjerognyenavn"
				},
				{
					"name": "EndretypeCAT"
				},
				{
					"name": "EndretypeVolvoCE"
				},
				{
					"name": "VolvoCEogCAT"
				},
				{
					"name": "TrimMachine"
				},
				{
					"name": "JoinMachine"
				},
				{
					"name": "FilterMachine"
				},
				{
					"name": "FilterUnmatched"
				},
				{
					"name": "SelectfromMachine"
				},
				{
					"name": "EndretypeVolvoTrucks"
				},
				{
					"name": "mlToLitre"
				},
				{
					"name": "FjernlinjerognyenavnVT"
				},
				{
					"name": "JoinMachineVT"
				},
				{
					"name": "FjernkolonnerVolvoTrucks"
				},
				{
					"name": "UnionVolvoTrucks"
				},
				{
					"name": "Window1"
				},
				{
					"name": "Lagfuel"
				},
				{
					"name": "Fueldiffhelp"
				},
				{
					"name": "Fueldiff"
				},
				{
					"name": "Sort1"
				},
				{
					"name": "Select1"
				},
				{
					"name": "Filter1"
				}
			],
			"script": "source(output(\n\t\tEquipmentHeader_SerialNumber as string,\n\t\tDatetime as timestamp,\n\t\tFuelConsumed as string,\n\t\tFuelUnits as string\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tisolationLevel: 'READ_UNCOMMITTED',\n\tformat: 'table') ~> VolvoCE\nsource(output(\n\t\t{EquipmentHeader.OEMName} as string,\n\t\t{EquipmentHeader.Model} as string,\n\t\t{EquipmentHeader.EquipmentID} as string,\n\t\t{EquipmentHeader.SerialNumber} as string,\n\t\t{Location.Latitude} as string,\n\t\t{Location.Longitude} as string,\n\t\t{Location.Altitude} as string,\n\t\t{Location.AltitudeUnits} as string,\n\t\t{Location.Datetime} as string,\n\t\t{CumulativeldleHours.Hour} as string,\n\t\t{CumulativeldleHours.Datetime} as string,\n\t\t{CumulativeOperationHours.Hour} as string,\n\t\t{CumulativeOperationHours.Datetime} as string,\n\t\t{DEFRemaining.Percent} as string,\n\t\t{DEFRemaining.Datetime} as string,\n\t\t{Distance.OdometerUnits} as string,\n\t\t{Distance.Odometer} as string,\n\t\t{EngineStatus.EngineNumber} as string,\n\t\t{EngineStatus.Running} as string,\n\t\t{EngineStatus.Datetime} as string,\n\t\t{FuelUsed.FuelUnits} as string,\n\t\t{Fuelused.FuelConsumed} as string,\n\t\t{FuelUsed.Datetime} as string,\n\t\t{FuelUsedLast24.FuelUnits} as string,\n\t\t{FuelUsedLast24.FuelConsumed} as string,\n\t\t{FuelUsedLast24.Datetime} as string,\n\t\t{FuelRemaining.Percent} as string,\n\t\t{FuelRemaining.Datetime} as string\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tisolationLevel: 'READ_UNCOMMITTED',\n\tformat: 'table') ~> CAT\nsource(output(\n\t\t{ResourceExternalRefs.ResourceNumber} as string,\n\t\t{ResourceExternalRefs.ExternalRefType} as string,\n\t\t{ResourceExternalRefs.ExternalRefValue} as string,\n\t\t{ResourceExternalRefs.Id} as string,\n\t\t{ResourceExternalRefs.CompanyId} as string,\n\t\t{ResourceExternalRefs.CompanyIds} as string,\n\t\t{ResourceExternalRefs.RecVersion} as integer,\n\t\tCompanyName as string,\n\t\tCanEdit as string,\n\t\tShowPrice as string,\n\t\tResourceExternalRefs as string,\n\t\tResourceNameFull as string,\n\t\tCapacityUnitId as string,\n\t\tCapacityRatioRock as double,\n\t\tCapacityRatioSoil as double,\n\t\tCapacityRatioClay as double,\n\t\tMeasureTon as string,\n\t\tFuelType as integer,\n\t\tFuelCapacity as integer,\n\t\tFuelConsumptionHour as double,\n\t\tFuelConsumptionCalculated as double,\n\t\tFuelStatus as double,\n\t\tFuelLastRefill as string,\n\t\tCostVariable as double,\n\t\tCostPriceCalculated as double,\n\t\tCostCalcDate as string,\n\t\tRunCostCalculation as string,\n\t\tCostPrice as double,\n\t\tMeasureTrips as string,\n\t\tPrice as double,\n\t\tAnnualInspectedDate as string,\n\t\tInsuranceExpiryDate as string,\n\t\tBuildYear as integer,\n\t\tEmissionClass as string,\n\t\tPurchasedDate as string,\n\t\tHourMeterInitial as integer,\n\t\tHourMeter as double,\n\t\tServiceDate as string,\n\t\tServiceHour as integer,\n\t\tServiceHourDueWarning as integer,\n\t\tServiceHourInterval as integer,\n\t\tSerialNumber as string,\n\t\tEngineNumber as string,\n\t\tRegistrationNumber as string,\n\t\tMachineId as string,\n\t\t{Type.TypeId} as string,\n\t\t{Type.Description} as string,\n\t\t{Type.BaseType} as integer,\n\t\t{Type.IsLoader} as string,\n\t\t{Type.IsDumper} as string,\n\t\t{Type.Id} as string,\n\t\t{Type.CompanyId} as integer,\n\t\t{Type.RecVersion} as integer,\n\t\tResourceNumber as string,\n\t\tDescription as string,\n\t\tProjIdCurrent as string,\n\t\tLocationText as string,\n\t\tGPSLocation as string,\n\t\tResponsibleId as string,\n\t\tWeight as double,\n\t\tCapacity as double,\n\t\tGeoCoordinate as string,\n\t\tAvatarImageId as string,\n\t\tAllowMultiTrans as string,\n\t\tNote as string,\n\t\tEquipmentTrainingEquipmentRef as string,\n\t\tActive as string,\n\t\tModifiedAt as string,\n\t\tModifiedByUserId as string,\n\t\tCreatedAt as string,\n\t\tCreatedByUserId as string,\n\t\tId as string,\n\t\tCompanyId as integer,\n\t\tRecVersion as integer\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tisolationLevel: 'READ_UNCOMMITTED',\n\tformat: 'table') ~> Machine\nsource(output(\n\t\tvin as string,\n\t\ttriggerType as string,\n\t\tcontext as string,\n\t\tcreatedDateTime as string,\n\t\treceivedDateTime as string,\n\t\ttotalEngineHours as string,\n\t\tengineTotalFuelUsed as string,\n\t\tdurationWheelbaseSpeedOverZero as string,\n\t\tdistanceCruiseControlActive as string,\n\t\tdurationCruiseControlActive as string,\n\t\tfuelConsumptionDuringCruiseActive as string,\n\t\tdurationWheelbaseSpeedZero as string,\n\t\tfuelWheelbaseSpeedZero as string,\n\t\tfuelWheelbaseSpeedOverZero as string,\n\t\tmoreDataAvailable as string,\n\t\trequestServerDateTime as string\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tisolationLevel: 'READ_UNCOMMITTED',\n\tformat: 'table') ~> VolvoTrucks\nCAT select(mapColumn(\n\t\tEquipmentHeader_SerialNumber = {EquipmentHeader.SerialNumber},\n\t\tFuelUnits = {FuelUsed.FuelUnits},\n\t\tFuelConsumed = {Fuelused.FuelConsumed},\n\t\tDatetime = {FuelUsed.Datetime}\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> Fjernlinjerognyenavn\nFjernlinjerognyenavn derive(Datetime = toTimestamp(Datetime, 'yyyy-MM-dd\\'T\\'HH:mm:ss') + hours(2),\n\t\tFuelConsumed = toInteger(FuelConsumed)) ~> EndretypeCAT\nVolvoCE derive(FuelConsumed = toInteger(trim(FuelConsumed))) ~> EndretypeVolvoCE\nEndretypeVolvoCE, EndretypeCAT union(byName: true)~> VolvoCEogCAT\nMachine derive(SerialNumber = trim(SerialNumber),\n\t\tEngineNumber = trim(EngineNumber)) ~> TrimMachine\nVolvoCEogCAT, FilterMachine join(EquipmentHeader_SerialNumber == SerialNumber,\n\tjoinType:'inner',\n\tbroadcast: 'auto')~> JoinMachine\nSelect1 filter(SerialNumber != 'null' || EngineNumber != 'null') ~> FilterMachine\nJoinMachine filter(ResourceNumber != 'null') ~> FilterUnmatched\nFilterUnmatched select(mapColumn(\n\t\tEquipmentHeader_SerialNumber,\n\t\tDatetime,\n\t\tFuelConsumed,\n\t\tFuelUnits,\n\t\tResourceNumber,\n\t\tId\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> SelectfromMachine\nVolvoTrucks derive(createdDateTime = toTimestamp(createdDateTime, 'yyyy-MM-dd\\'T\\'HH:mm:ss') + hours(2),\n\t\treceivedDateTime = toTimestamp(receivedDateTime, 'yyyy-MM-dd\\'T\\'HH:mm:ss') + hours(2),\n\t\tengineTotalFuelUsed = toInteger(engineTotalFuelUsed),\n\t\tvin = trim(vin)) ~> EndretypeVolvoTrucks\nSort1 derive({engineTotalFuelUsed Liter} = engineTotalFuelUsed / 1000) ~> mlToLitre\nmlToLitre select(mapColumn(\n\t\tDatetime = receivedDateTime,\n\t\tEquipmentHeader_SerialNumber = vin,\n\t\tFuelConsumed = {engineTotalFuelUsed Liter}\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> FjernlinjerognyenavnVT\nFjernlinjerognyenavnVT, FilterMachine join(EquipmentHeader_SerialNumber == EngineNumber,\n\tjoinType:'inner',\n\tbroadcast: 'auto')~> JoinMachineVT\nJoinMachineVT select(mapColumn(\n\t\tDatetime,\n\t\tEquipmentHeader_SerialNumber,\n\t\tFuelConsumed,\n\t\tResourceNumber,\n\t\tId\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> FjernkolonnerVolvoTrucks\nSelectfromMachine, FjernkolonnerVolvoTrucks union(byName: true)~> UnionVolvoTrucks\nUnionVolvoTrucks window(asc(EquipmentHeader_SerialNumber, true),\n\tasc(Datetime, true),\n\tPreviousFuelConsumed = lag(FuelConsumed,1),\n\t\tPreviousEquipment_SerialNumber = lag(EquipmentHeader_SerialNumber,1)) ~> Window1\nWindow1 derive(Lag_fuel = iif(EquipmentHeader_SerialNumber == PreviousEquipment_SerialNumber, PreviousFuelConsumed, 0)) ~> Lagfuel\nLagfuel derive(Fueldiff_hjelp = FuelConsumed - Lag_fuel) ~> Fueldiffhelp\nFueldiffhelp derive(Fueldiff = iif(Lag_fuel<=FuelConsumed, Fueldiff_hjelp, 0)) ~> Fueldiff\nEndretypeVolvoTrucks sort(asc(receivedDateTime, true)) ~> Sort1\nTrimMachine select(mapColumn(\n\t\tSerialNumber,\n\t\tEngineNumber,\n\t\tResourceNumber,\n\t\tId\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> Select1\nFueldiff filter(Fueldiff <= 1010) ~> Filter1\nFilter1 sink(allowSchemaDrift: true,\n\tvalidateSchema: false,\n\tinput(\n\t\tEquipmentHeader_SerialNumber as string,\n\t\tDatetime as timestamp,\n\t\tFuelConsumed as integer,\n\t\tResourceNumber as string,\n\t\tFueldiff as integer,\n\t\tProjectNumber as string\n\t),\n\tdeletable:false,\n\tinsertable:true,\n\tupdateable:false,\n\tupsertable:false,\n\tformat: 'table',\n\tpreSQLs:['TRUNCATE TABLE dbo.AllFuel'],\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true,\n\terrorHandlingOption: 'stopOnFirstError',\n\tmapColumn(\n\t\tEquipmentHeader_SerialNumber,\n\t\tDatetime,\n\t\tFuelConsumed,\n\t\tResourceNumber,\n\t\tFueldiff\n\t)) ~> sink1"
		}
	}
}